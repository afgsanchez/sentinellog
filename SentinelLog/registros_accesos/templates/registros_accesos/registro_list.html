{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Registros de Control de Accesos</h2>
{% if messages %}
  <div class="container mt-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}



    <form method="get" class="row g-2 mb-3 align-items-end">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" placeholder="Buscar en todos los campos" value="{{ search }}">
        </div>
        <div class="col-md-2">
            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
        </div>
        <div class="col-md-2">
            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
        </div>
        <div class="col-md-2">
            <select name="ordering" class="form-select">
                <option value="-fecha" {% if ordering == "-fecha" %}selected{% endif %}>M치s recientes</option>
                <option value="fecha" {% if ordering == "fecha" %}selected{% endif %}>M치s antiguos</option>
                <option value="nombre_apellidos" {% if ordering == "nombre_apellidos" %}selected{% endif %}>Nombre A-Z</option>
            </select>
        </div>
        <div class="col-md-3 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            <a href="{% url 'registro_list' %}" class="btn btn-secondary btn-sm">Limpiar</a>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal">
        游닌 Importar Excel
            </button>
        </div>
    </form>

    <!-- Modal Bootstrap -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" action="{% url 'registro_import' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">Importar registros desde Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="excelFile" class="form-label">Selecciona el archivo Excel</label>
            <input class="form-control" type="file" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Importar</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Hora Entrada</th>
                    <th>Matr칤cula</th>
                    <th>Nombre y Apellidos</th>
                    <th>Nombre Empresa</th>
                    <th>Donde se dirigen</th>
                    <th>Hora Salida</th>
                    <th>Entrega Tarjeta</th>
                    <th>Devoluci칩n Tarjeta</th>
                    <th>Tipo</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in page_obj %}
                <tr>
                    <td>{{ reg.fecha }}</td>
                    <td>{{ reg.hora_entrada }}</td>
                    <td>{{ reg.matricula }}</td>
                    <td>{{ reg.nombre_apellidos }}</td>
                    <td>{{ reg.nombre_empresa }}</td>
                    <td>{{ reg.donde_se_dirigen }}</td>
                    <td>{{ reg.hora_salida }}</td>
                    <td>{{ reg.entrega_tarjeta }}</td>
                    <td>{{ reg.devolucion_tarjeta }}</td>
                    <td>{{ reg.get_tipo_display }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted">No hay registros.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Paginaci칩n #}
    <nav aria-label="Paginaci칩n">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}{% if ordering %}ordering={{ ordering }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo;</a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
                <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                    <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}{% if ordering %}ordering={{ ordering }}&{% endif %}page={{ num }}">{{ num }}</a>
                </li>
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}{% if ordering %}ordering={{ ordering }}&{% endif %}page={{ page_obj.next_page_number }}">&raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}
